bundle:
  name: zillow-ai-demo

variables:
  catalog:
    description: Unity Catalog name for the Zillow demo
    default: zillow_demo
  schema:
    description: Schema within the catalog
    default: listings
  warehouse_id:
    description: SQL warehouse ID for notebook jobs

resources:
  # ── Setup Notebooks (run sequentially to bootstrap data + models) ────────
  jobs:
    zillow_setup_pipeline:
      name: zillow-ai-setup-pipeline
      tasks:
        - task_key: generate_data
          notebook_task:
            notebook_path: ./notebooks/01_generate_data.py
            source: WORKSPACE
          environment_key: default

        - task_key: vector_search_setup
          depends_on:
            - task_key: generate_data
          notebook_task:
            notebook_path: ./notebooks/02_vector_search_setup.py
            source: WORKSPACE
          environment_key: default

        - task_key: train_price_model
          depends_on:
            - task_key: generate_data
          notebook_task:
            notebook_path: ./notebooks/03_train_price_model.py
            source: WORKSPACE
          environment_key: default

      environments:
        - environment_key: default
          spec:
            client: "1"

  # ── Streamlit App ────────────────────────────────────────────────────────
  apps:
    zillow_app:
      name: "zillow-ai-demo"
      description: "Zillow Re-imagined with AI — Property search, AI chat, and market insights powered by the full Databricks stack."
      source_code_path: .
      config:
        command:
          - "streamlit"
          - "run"
          - "app.py"
          - "--server.port"
          - "8501"
          - "--server.address"
          - "0.0.0.0"
        env:
          - name: "DATABRICKS_HOST"
            value: "${workspace.host}"
      resources:
        - name: "zillow-setup-job"
          description: "Reference to the setup pipeline job"
          job:
            id: ${resources.jobs.zillow_setup_pipeline.id}
            permission: "CAN_MANAGE_RUN"
        - name: "zillow-sql-warehouse"
          description: "SQL warehouse for market insight queries"
          sql_warehouse:
            id: ${var.warehouse_id}
            permission: "CAN_USE"
      permissions:
        - user_name: ${workspace.current_user.userName}
          level: "CAN_MANAGE"

targets:
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

  prod:
    mode: production
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}
